<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard - Creato Studios</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    .toast {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 24px;
      background: rgba(0, 0, 0, 0.85);
      color: #fff;
      padding: 10px 16px;
      border-radius: 8px;
      font-size: 13px;
      z-index: 9999;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.5);
    }

    .muted {
      color: #9ca3af
    }
  </style>
</head>

<body class="bg-[#050505] text-white font-sans antialiased">
  <div class="flex min-h-screen">

    <!-- SIDEBAR -->
    <aside class="w-64 border-r border-white/10 p-8 flex flex-col gap-6">
      <div class="h-12 w-48 flex items-center relative">
        <a href="index.html" class="absolute left-0 top-1/2 -translate-y-1/2">
          <img src="image/image.png" alt="Logo" class="h-28 w-auto object-contain">
        </a>
      </div>

      <!-- NAV -->
      <nav class="flex flex-col gap-4 text-sm font-medium mt-6">
        <button id="overviewTab" class="text-white flex items-center gap-3 text-left">
          <span class="w-2 h-2 bg-white rounded-full"></span> Overview
        </button>

        <button id="campaignTab" class="text-gray-400 hover:text-white transition text-left">
          Campaigns
        </button>
      </nav>

      <!-- USER PROFILE & REFERRAL -->
      <div class="mt-auto pt-6 border-t border-white/10">
        <div class="mb-5">
          <p class="text-[11px] text-gray-400 uppercase tracking-widest">Influencer ID</p>
          <p id="userIdBox" class="text-sm font-bold text-white">--</p>

          <p class="text-[11px] text-gray-400 mt-3 uppercase tracking-widest">Email</p>
          <p id="profileEmail" class="text-sm text-gray-200 break-all">loading...</p>
        </div>

        <div class="border-t border-white/10 pt-4">
          <p class="text-[11px] text-gray-400 uppercase tracking-widest mb-2">Referral Code</p>

          <div class="flex items-center gap-2 mb-2">
            <input id="referralInput" readonly class="bg-[#111] text-white text-sm px-3 py-2 rounded w-full"
              value="Loading..." />
            <button id="copyCodeBtn" class="bg-white text-black px-3 py-2 rounded text-xs font-bold">Copy</button>
          </div>

          <p class="text-[11px] text-gray-400 mt-1 uppercase tracking-widest mb-2">Auto Link</p>
          <div class="flex items-center gap-2 mb-3">
            <input id="referralLinkInput" readonly class="bg-[#111] text-white text-sm px-3 py-2 rounded w-full"
              value="Loading..." />
            <button id="copyLinkBtn" class="bg-white text-black px-3 py-2 rounded text-xs font-bold">Link</button>
          </div>

          <div class="mt-1 grid grid-cols-1 sm:grid-cols-2 gap-2">
            <button id="waShareBtn"
              class="w-full bg-green-500 text-white px-3 py-2 rounded text-xs font-semibold">WhatsApp</button>
            <button id="fbShareBtn"
              class="w-full bg-blue-600 text-white px-3 py-2 rounded text-xs font-semibold">Facebook</button>
            <button id="igShareBtn"
              class="sm:col-span-2 bg-pink-500 text-white px-3 py-2 rounded text-xs font-semibold">Instagram</button>
          </div>
        </div>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="flex-1 p-8">
      <header class="flex justify-between items-center mb-8">
        <div>
          <h2 class="text-3xl font-bold italic">Performance Report</h2>
          <p class="text-gray-500 text-sm">Real-time tracking of your influence.</p>
        </div>

        <div class="flex items-center gap-4">
          <div class="bg-white/5 border border-white/10 px-6 py-3 rounded-2xl">
            <span class="text-[10px] uppercase text-gray-500 block mb-1">Your Generated Code</span>
            <span id="generatedCode" class="font-mono font-bold text-white tracking-widest uppercase">CREATO-X92</span>
          </div>

          <button id="logoutBtn" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-xl text-sm font-semibold">
            Logout
          </button>
        </div>
      </header>

      <!-- OVERVIEW -->
      <section id="overviewSection" class="space-y-8">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div class="bg-[#111] p-6 rounded-2xl border border-white/5">
            <p class="text-gray-500 text-xs uppercase tracking-widest mb-2 font-bold">Total Earnings</p>
            <h3 id="earnings" class="text-3xl font-black">₹0</h3>
          </div>
          <div class="bg-[#111] p-6 rounded-2xl border border-white/5">
            <p class="text-gray-500 text-xs uppercase tracking-widest mb-2 font-bold">Total Clicks</p>
            <h3 id="clicks" class="text-3xl font-black">0</h3>
          </div>
          <div class="bg-[#111] p-6 rounded-2xl border border-white/5">
            <p class="text-gray-500 text-xs uppercase tracking-widest mb-2 font-bold">Conversions</p>
            <h3 id="conversions" class="text-3xl font-black">0</h3>
          </div>
        </div>

        <div>
          <div class="flex justify-between items-end mb-4">
            <h3 class="text-xl font-bold">Joined Campaigns</h3>
            <a href="#" id="browseDeals" class="text-xs text-gray-500 hover:text-white transition underline">Browse
              Brand Deals</a>
          </div>

          <div class="bg-[#111] rounded-2xl border border-white/5 overflow-hidden">
            <table class="w-full text-left">
              <thead>
                <tr class="text-[10px] uppercase tracking-widest text-gray-500 border-b border-white/5">
                  <th class="px-6 py-4">Campaign Name</th>
                  <th class="px-6 py-4">Status</th>
                  <th class="px-6 py-4">ID (PK)</th>
                  <th class="px-6 py-4 text-right">Action</th>
                </tr>
              </thead>
              <tbody id="joinedCampaignsTbody" class="text-sm">
                <tr class="border-b border-white/5">
                  <td class="px-6 py-4 font-semibold">Loading joined campaigns...</td>
                  <td class="px-6 py-4 muted">—</td>
                  <td class="px-6 py-4 font-mono text-xs opacity-50">—</td>
                  <td class="px-6 py-4 text-right"></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- CAMPAIGNS SECTION -->
      <section id="campaignSection" class="hidden space-y-6">
        <div class="flex items-center justify-between">
          <h2 class="text-2xl font-bold">Available Campaigns</h2>
          <p class="text-sm text-gray-400">Join campaigns to earn rewards and get featured.</p>
        </div>

        <div class="bg-[#111] rounded-2xl border border-white/5 overflow-hidden">
          <table class="w-full text-left">
            <thead>
              <tr class="text-[10px] uppercase tracking-widest text-gray-500 border-b border-white/5">
                <th class="px-6 py-4">Campaign</th>
                <th class="px-6 py-4">Brand</th>
                <th class="px-6 py-4">Status</th>
                <th class="px-6 py-4">Payout</th>
                <th class="px-6 py-4 text-right">Action</th>
              </tr>
            </thead>
            <tbody id="campaignList" class="text-sm">
              <tr class="border-b border-white/5">
                <td class="px-6 py-4 font-semibold">Loading campaigns...</td>
                <td class="px-6 py-4">—</td>
                <td class="px-6 py-4">—</td>
                <td class="px-6 py-4">—</td>
                <td class="px-6 py-4 text-right"></td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>
    </main>
  </div>

  <script>
    (function () {
      const STORAGE_KEY = "Bearer";
      const API_BASE = "https://creatostudiosbackend.vercel.app/v1"; // your API base
      const SITE_BASE = "https://lightyellow-butterfly-362806.hostingersite.com/signup.html"; // signup url
      const POLL_INTERVAL_MS = 0;

      // store user/referral globally after profile fetch
      let currentReferralCode = null;
      let currentUserId = null;

      /** Helpers **/
      function escapeHtml(str) {
        if (str === null || str === undefined) return "";
        return String(str)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      function showToast(msg) {
        const t = document.createElement("div");
        t.className = "toast";
        t.innerText = msg;
        document.body.appendChild(t);
        setTimeout(() => t.remove(), 2200);
      }

      async function writeToClipboard(text) {
        try {
          if (navigator.clipboard && navigator.clipboard.writeText) {
            await navigator.clipboard.writeText(text);
            return true;
          } else {
            const ta = document.createElement("textarea");
            ta.value = text;
            document.body.appendChild(ta);
            ta.select();
            document.execCommand("copy");
            ta.remove();
            return true;
          }
        } catch (e) {
          console.error("copy failed", e);
          return false;
        }
      }

      function logout() {
        localStorage.removeItem(STORAGE_KEY);
        window.location.replace("signin.html");
      }

      // Build final campaign link with referral code
      function buildCampaignLink(rawLink) {
        const code = currentReferralCode;
        if (!rawLink) {
          if (!code) return SITE_BASE;
          return `${SITE_BASE}?ref=${encodeURIComponent(code)}`;
        }

        // If placeholder pattern exists, replace it
        if (rawLink.includes("{CODE}")) {
          return rawLink.replace(/\{CODE\}/g, encodeURIComponent(code || ""));
        }

        // If link already contains ref query param, return as-is
        if (rawLink.includes("ref=")) return rawLink;

        // Append ref param if we have code
        if (code) {
          // keep existing query params if present
          return rawLink.includes("?") ? `${rawLink}&ref=${encodeURIComponent(code)}` : `${rawLink}?ref=${encodeURIComponent(code)}`;
        }

        return rawLink;
      }

      /** Wire UI buttons **/
      document.getElementById("logoutBtn").addEventListener("click", logout);
      document.getElementById("copyCodeBtn").addEventListener("click", async () => {
        const code = document.getElementById("referralInput").value;
        if (!code || code === "N/A") return showToast("No referral");
        const ok = await writeToClipboard(code);
        if (ok) showToast("Referral code copied");
      });
      document.getElementById("copyLinkBtn").addEventListener("click", async () => {
        const link = document.getElementById("referralLinkInput").value;
        if (!link || link === "N/A") return showToast("No link");
        const ok = await writeToClipboard(link);
        if (ok) showToast("Referral link copied");
      });
      document.getElementById("waShareBtn").addEventListener("click", () => {
        const link = document.getElementById("referralLinkInput").value;
        const code = document.getElementById("referralInput").value;
        const text = link && link !== "N/A" ? `Join using my referral link: ${link}` : `Join using my referral code: ${code}`;
        window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, "_blank");
      });
      document.getElementById("fbShareBtn").addEventListener("click", () => {
        const link = document.getElementById("referralLinkInput").value;
        if (link && link !== "N/A") {
          window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(link)}`, "_blank");
        } else {
          const code = document.getElementById("referralInput").value || "";
          window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(SITE_BASE)}&quote=${encodeURIComponent("Use my referral: " + code)}`, "_blank");
        }
      });
      document.getElementById("igShareBtn").addEventListener("click", () => {
        showToast("Instagram: copy & paste the link into stories/DMs/bio.");
      });

      /** Tabs **/
      const overviewTab = document.getElementById("overviewTab");
      const campaignTab = document.getElementById("campaignTab");
      const overviewSection = document.getElementById("overviewSection");
      const campaignSection = document.getElementById("campaignSection");

      overviewTab.addEventListener("click", () => {
        overviewSection.classList.remove("hidden");
        campaignSection.classList.add("hidden");
        overviewTab.classList.add("text-white");
        campaignTab.classList.remove("text-white");
      });

      campaignTab.addEventListener("click", () => {
        overviewSection.classList.add("hidden");
        campaignSection.classList.remove("hidden");
        campaignTab.classList.add("text-white");
        overviewTab.classList.remove("text-white");
        loadCampaigns(); // fetch campaigns on open
      });

      /** Load profile + summary stats **/
      async function loadProfileAndStats() {
        const token = localStorage.getItem(STORAGE_KEY);
        if (!token) return logout();

        try {
          const res = await fetch(`${API_BASE}/influencer/dashboard`, {
            method: "GET",
            headers: { "Authorization": `Bearer ${token}`, "Content-Type": "application/json" }
          });

          if (!res.ok) {
            if (res.status === 401 || res.status === 403) return logout();
            console.warn("dashboard fetch failed:", res.status);
            return;
          }

          const data = await res.json();

          // support flexible shapes
          currentUserId = data.id ?? data.user?.id ?? null;
          const email = data.email ?? data.user?.email ?? "";
          const code = data.referral_code ?? data.referralCode ?? data.user?.referral_code ?? null;
          const clicks = Number(data.clicks ?? data.total_clicks ?? 0);
          const conversions = Number(data.conversions ?? data.total_conversions ?? 0);

          currentReferralCode = code && code !== "N/A" ? code : null;

          document.getElementById("userIdBox").innerText = currentUserId ? String(currentUserId) : "--";
          document.getElementById("profileEmail").innerText = email || "—";
          document.getElementById("generatedCode").innerText = code ? escapeHtml(code) : "N/A";
          document.getElementById("referralInput").value = code ? code : "N/A";
          document.getElementById("referralLinkInput").value = code ? `${SITE_BASE}?ref=${encodeURIComponent(code)}` : "N/A";
          document.getElementById("clicks").innerText = String(clicks);
          document.getElementById("conversions").innerText = String(conversions);
          document.getElementById("earnings").innerText = `₹${(conversions * 100).toLocaleString()}`;

        } catch (err) {
          console.error("Profile/Dashboard error:", err);
          // don't auto logout on network failure — keep user on page
        }
      }

      /** Load all campaigns (for campaigns tab) **/
      async function loadCampaigns() {
        const token = localStorage.getItem(STORAGE_KEY);
        if (!token) return logout();

        const tbody = document.getElementById("campaignList");
        tbody.innerHTML = `<tr class="border-b border-white/5"><td class="px-6 py-4" colspan="5">Loading campaigns...</td></tr>`;

        try {
          const res = await fetch(`${API_BASE}/campaigns/data`, {
            method: "GET",
            headers: { "Authorization": `Bearer ${token}`, "Content-Type": "application/json" }
          });

          if (!res.ok) {
            tbody.innerHTML = `<tr class="border-b border-white/5"><td class="px-6 py-4" colspan="5">Unable to load campaigns (server error).</td></tr>`;
            return;
          }

          const result = await res.json();
          const campaigns = result.data ?? result.campaigns ?? [];

          if (!campaigns.length) {
            tbody.innerHTML = `<tr class="border-b border-white/5"><td class="px-6 py-4" colspan="5">No campaigns available.</td></tr>`;
            return;
          }

          tbody.innerHTML = "";
          campaigns.forEach(c => {
            // accept both shapes: c.name or c.campaign_name
            const name = escapeHtml(c.campaign_name ?? c.name ?? "Untitled Campaign");
            const brand = escapeHtml(c.brand_name ?? c.brand ?? c.organizer ?? "—");
            const status = escapeHtml(c.status ?? "Active");
            const payout = c.payout ? `₹${Number(c.payout).toLocaleString()}` : (escapeHtml(c.payout_text ?? "—"));
            const campaignId = c.id ?? c.campaign_id;
            const joined = !!c.joined; // optional server-provided flag
            const rawCampaignLink = c.campaign_link ?? c.link ?? null;

            // <-- ONLY CHANGED: use campaign_link or link if present, else fallback to SITE_BASE
            const finalLink = c.campaign_link ?? c.link ?? SITE_BASE;


            const tr = document.createElement("tr");
            tr.className = "border-b border-white/5 hover:bg-white/[0.02] transition";

            // If joined -> Visit button linking to campaign
            const actionHtml = joined
              ? `<a href="${escapeHtml(finalLink)}" target="_blank" rel="noopener" class="bg-green-600 text-white px-4 py-2 rounded text-xs font-semibold">Visit</a>`
              : `<button data-id="${campaignId}" class="join-btn bg-white text-black px-4 py-2 rounded text-xs font-bold">Join</button>`;

            tr.innerHTML = `
            <td class="px-6 py-4 font-semibold">${name}</td>
            <td class="px-6 py-4">${brand}</td>
            <td class="px-6 py-4">${status}</td>
            <td class="px-6 py-4">${payout}</td>
            <td class="px-6 py-4 text-right">${actionHtml}</td>
          `;

            tbody.appendChild(tr);
          });

          // attach handlers for join buttons
          document.querySelectorAll(".join-btn").forEach(btn => {
            btn.addEventListener("click", (e) => {
              const id = e.currentTarget.getAttribute("data-id");
              if (!id) return;
              joinCampaign(id, e.currentTarget);
            });
          });

        } catch (err) {
          console.error("Campaign load failed", err);
          tbody.innerHTML = `<tr class="border-b border-white/5"><td class="px-6 py-4" colspan="5">Network error loading campaigns.</td></tr>`;
        }
      }

      /** Join campaign **/
      async function joinCampaign(campaignId, buttonEl = null) {
        const token = localStorage.getItem(STORAGE_KEY);
        if (!token) return logout();

        if (buttonEl) {
          buttonEl.disabled = true;
          buttonEl.innerText = "Joining...";
        }

        try {
          const res = await fetch(`${API_BASE}/campaigns/join`, {
            method: "POST",
            headers: { "Authorization": `Bearer ${token}`, "Content-Type": "application/json" },
            body: JSON.stringify({ campaignId })
          });

          const result = await res.json();

          if (res.ok && result.success) {
            showToast("Joined campaign successfully!");
            // refresh both lists
            await loadCampaigns();
            await loadJoinedCampaigns();
            await loadProfileAndStats();
            return;
          } else {
            const msg = result.message || "Failed to join campaign";
            showToast(msg);
          }
        } catch (err) {
          console.error("Join error:", err);
          showToast("Error joining campaign");
        } finally {
          if (buttonEl) {
            buttonEl.disabled = false;
            buttonEl.innerText = "Join";
          }
        }
      }

      /**
       * loadJoinedCampaigns:
       * 1) GET /v1/influencer/dashboard  -> get campaign_ids []
       * 2) POST /v1/campaigns/by-ids      -> body { campaign_ids: [...] } -> get campaign details
       * 3) render those campaigns into Joined Campaigns table
       */
      async function loadJoinedCampaigns() {
        const token = localStorage.getItem(STORAGE_KEY);
        if (!token) return logout();

        const tbody = document.getElementById("joinedCampaignsTbody");
        tbody.innerHTML = `<tr class="border-b border-white/5"><td class="px-6 py-4" colspan="4">Loading joined campaigns...</td></tr>`;

        try {
          // Step 1: fetch dashboard to get campaign_ids
          const dashRes = await fetch(`${API_BASE}/influencer/dashboard`, {
            method: "GET",
            headers: { "Authorization": `Bearer ${token}`, "Content-Type": "application/json" }
          });

          if (!dashRes.ok) {
            tbody.innerHTML = `<tr class="border-b border-white/5"><td class="px-6 py-4" colspan="4">Unable to load joined campaigns (dashboard error).</td></tr>`;
            return;
          }

          const dashData = await dashRes.json();

          // server may return CSV string or array; normalize to array
          let ids = dashData.campaign_ids ?? dashData.data?.campaign_ids ?? dashData.campaign_ids_csv ?? [];
          if (typeof ids === "string") {
            // allow both comma-separated string or JSON string
            try {
              const trimmed = ids.trim();
              if (trimmed === "") ids = [];
              else if (trimmed.startsWith("[") || trimmed.startsWith("{")) ids = JSON.parse(trimmed);
              else ids = trimmed.split(",").map(x => x.trim()).filter(Boolean);
            } catch (e) {
              ids = ids.split(",").map(x => x.trim()).filter(Boolean);
            }
          }

          if (!Array.isArray(ids) || ids.length === 0) {
            tbody.innerHTML = `<tr class="border-b border-white/5"><td class="px-6 py-4" colspan="4">No joined campaigns yet</td></tr>`;
            return;
          }

          // Step 2: request campaign details for these ids
          const res = await fetch(`${API_BASE}/campaigns/by-ids`, {
            method: "POST",
            headers: { "Authorization": `Bearer ${token}`, "Content-Type": "application/json" },
            body: JSON.stringify({ campaign_ids: ids })
          });

          if (!res.ok) {
            tbody.innerHTML = `<tr class="border-b border-white/5"><td class="px-6 py-4" colspan="4">Unable to load campaign details.</td></tr>`;
            return;
          }

          const result = await res.json();
          const list = result.data ?? [];

          if (!Array.isArray(list) || list.length === 0) {
            tbody.innerHTML = `<tr class="border-b border-white/5"><td class="px-6 py-4" colspan="4">No joined campaigns found.</td></tr>`;
            return;
          }

          // Render joined campaigns (with Visit button)
          tbody.innerHTML = "";
          list.forEach(c => {
            const name = escapeHtml(c.campaign_name ?? c.name ?? "Untitled");
            const status = escapeHtml(c.status ?? "—");
            const id = escapeHtml(String(c.id ?? c.campaign_id ?? ""));
            const rawCampaignLink = c.campaign_link ?? c.link ?? null;

            // <-- ONLY CHANGED: use campaign_link or link if present, else fallback to SITE_BASE
            const finalLink = c.campaign_link ?? c.link ?? SITE_BASE;

            const tr = document.createElement("tr");
            tr.className = "border-b border-white/5";
            tr.innerHTML = `
            <td class="px-6 py-4 font-semibold">${name}</td>
            <td class="px-6 py-4">${status}</td>
            <td class="px-6 py-4 font-mono text-xs opacity-50">${id}</td>
            <td class="px-6 py-4 text-right">
              <a href="${escapeHtml(finalLink)}" target="_blank" rel="noopener" class="bg-green-600 text-white px-3 py-1 rounded text-xs font-semibold">Visit</a>
            </td>
          `;
            tbody.appendChild(tr);
          });

        } catch (err) {
          console.error("joined campaigns failed", err);
          tbody.innerHTML = `<tr class="border-b border-white/5"><td class="px-6 py-4" colspan="4">Error loading joined campaigns.</td></tr>`;
        }
      }

      /** Init */
      (function init() {
        loadProfileAndStats();
        loadJoinedCampaigns();
        // start on overview
        overviewSection.classList.remove("hidden");
        campaignSection.classList.add("hidden");
        overviewTab.classList.add("text-white");
        if (POLL_INTERVAL_MS > 0) setInterval(loadProfileAndStats, POLL_INTERVAL_MS);
      })();

    })();
  </script>
</body>

</html>
